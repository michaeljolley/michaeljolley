---
import { getWebMentions } from '../../scripts/webmentions.js'

export async function getStaticPaths() {
	const allPosts = await Astro.glob('../../content/blog/**/*.md');
	const sortedPosts = allPosts.sort((a, b) => new Date(b.frontmatter.date) - new Date(a.frontmatter.date));

	const webMentions = await getWebMentions();

	return sortedPosts.map((post) => {
		const pathParts = post.file.replace('/index.md', '').split('/');
		const slug = pathParts[pathParts.length - 1];

		const url = `https://baldbeardedbuilder.com/blog/${slug}/`;

		const mentions = webMentions.children.filter(entry => entry['wm-target'] === url)

		return {
			params: {
				slug
			},
			props: {
				post,
				mentions
			}
		}
	})
}

import Layout from '../../layouts/Default.astro';
import TableOfContents from '../../components/TableOfContents';
import RelatedPosts from '../../components/RelatedPosts.astro';
import Topper from '../../components/Topper.astro';

const { post, mentions } = Astro.props;
const { slug } = Astro.params;

console.log(slug)
console.dir(mentions, { depth: null })

const { title, description, tags, date, canonical_url } = post.frontmatter;
const permalink = `https://baldbeardedbuilder.com/blog/${slug}/`;

const canonicalUrl = canonical_url;
const canonicalHost = canonicalUrl ? (new URL(canonicalUrl)).hostname : undefined;
const canonicalMsg = canonicalUrl ? `Originally published at <a href="${canonicalUrl}">${canonicalHost}</a>.` : '';

let headers = await post.getHeadings();
---

	<Layout {title} {description} {permalink} {tags} {canonicalUrl}>
		<Topper>
			<h1>{title}</h1>
			<p class="small" set:html={canonicalMsg}></p>
		</Topper>
		<article class="post">
			<main>
				<aside>
					<TableOfContents {headers} client:load />
				</aside>
				<section class="content">
					<post.Content />
				</section>
			</main>
			<footer>
				<RelatedPosts post={post} />
			</footer>
		</article>
	</Layout>
